---
title: "Analysis"
author: "Derek Brickley"
date: "1/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning=FALSE)
```

```{r, warning=FALSE}
library(MASS)
library(gridExtra)  
library(mnormt) 
library(lme4) 
library(knitr) 
library(kableExtra)
library(tidyverse)
library(GGally)
library(mice)
library(nlme)
library(boot)
library(HLMdiag)
library(pander)
library(skimr)
library(corrplot)
```

```{r}
sports <- read.csv("Full_Data.csv")
```

```{r, results = 'hide'}
head(sports, 5)
```

```{r}
skim(sports)
```

```{r, results = "hide"}
sports %>% count(School)
sports %>% count(Start.Year)
```


```{r, results = 'hide'}
select <- dplyr::select
keydata <- sports %>% 
  dplyr::select(Rank, W, L, T, program.id,
      Pct, Start.Year, Sport, School, State, Multi.Year.APR, Penalties, Postseason)
# Create Level2 data set by picking off one observation 
# per subject, which would be easier if every subject 
# had a diary entry labeled '1' - should be 37 rows 
# and 6 columns (one per L2 variable)
school.lev2 <-  keydata %>%
  group_by(School) %>%
  filter(row_number() == 1) %>%
  select(School, Start.Year)

year.lev2 <-  keydata %>%
  group_by((Start.Year)) %>%
  filter(row_number() == 1) %>%
  select(School, Start.Year)
```

```{r}
meanbyschool <- sports %>% group_by(School) %>%
  summarise(meanbyschool = mean(Multi.Year.APR, na.rm = TRUE))
school.lev2 <- school.lev2 %>%
  left_join(meanbyschool, by = "School")

meanbyyear <- sports %>% group_by(Start.Year) %>%
  summarise(meanbyyear = mean(Multi.Year.APR, na.rm = TRUE))
year.lev2 <- year.lev2 %>%
  left_join(meanbyyear, by = "Start.Year")
```

```{r, results = 'hide'}
sports %>% count(Sport)
```

```{r}
theme.1 <- theme(axis.title.x = element_text(size = 14),
  axis.title.y = element_text(size = 14),
  plot.title=element_text(hjust=.9,face="italic",size=12))
## Histogram of negative affect frequencies
apr.all <- ggplot(data=sports,aes(x=Multi.Year.APR)) + 
  geom_histogram(binwidth = 20, fill = "white",color = "black") + 
  theme.1 + xlim(400,1000) +
  xlab("Multi Year APR Score") + ylab("Frequency") + labs(title="(a)") 

apr.mean <- ggplot(data=school.lev2,aes(x=meanbyschool)) + 
  geom_histogram(binwidth = 20, fill = "white", 
                 color = "black") + 
  theme.1 + xlim(800,1000) +
  xlab("Mean APR Score by School") + ylab("Frequency") + labs(title="(b)") 

year.apr.mean <- ggplot(data=year.lev2,aes(x=meanbyyear)) + 
  geom_histogram(binwidth = 20, fill = "white", 
                 color = "black") + 
  theme.1 + xlim(800,1000) +
  xlab("Mean APR Score by Year") + ylab("Frequency") + labs(title="(c)") 
mli.hist1 <- grid.arrange(apr.all,apr.mean,year.apr.mean, ncol=1)
```

```{r}
box.sport <- ggplot(data=sports,aes(factor(Sport),Multi.Year.APR)) +
  geom_boxplot() + 
  theme.1 + coord_flip() + ylab("Multi-Year APR") + 
  xlab("") + labs(title="(a)")

mli.boxscatmat1 <- grid.arrange(box.sport,ncol=1)
```

```{r}
ggplot(sports,aes(x=Start.Year,y=Multi.Year.APR)) +
  geom_smooth(method= "lm", color = "black") + 
  labs(x="Academic Year",y="Multi-Year APR Score") +
  theme.1
```

```{r}
select_sports <- sports %>% select(Pct, centeredAPR, pcip09, ugds, ugds_men, ugds_white, costt4_a, age_entry) %>%
  rename('Win Percentage' = Pct, "APR" = centeredAPR, "Percent Communication" = pcip09, "Students Enrolled" = ugds, "Percent Male" = ugds_men, "Percent White" = ugds_white, "Average Cost" = costt4_a, "Average age at entry" = age_entry)
Corr <- cor(select_if(select_sports, is.numeric), use="complete.obs")
corrplot(Corr)
```

```{r}
LMRegion <- ggplot(sports, aes(x = centeredAPR, y = Pct, color = as.factor(region))) +
  geom_smooth(method='lm') + 
  theme.1 + xlim(-200,25)

LMRegion
```

```{r}
set.seed(1313)
randschool = as.vector(sample(sports$School,size=25))
schoolsrd <- sports %>%
  filter(School %in% randschool) %>%
  group_by(School, Start.Year) %>%
  summarize(meanAPR = mean(Multi.Year.APR, na.rm = TRUE))
  
ggplot(schoolsrd, aes(x=Start.Year, y=meanAPR)) + 
  facet_wrap(~School,ncol=5) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  theme.1 +
  theme(strip.text.x=element_blank()) + 
  labs(x="Academic Year",y="Average Multi-Year APR Score")
```

```{r}
set.seed(1313)
randsport = as.vector(sample(sports$School,size=4))

sportsrd <- sports %>%
  filter(School %in% randsport)
  
ggplot(sportsrd, aes(x=Start.Year, y=Multi.Year.APR)) + 
  facet_wrap(~program.id,ncol=4) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  theme.1 +
  theme(strip.text.x=element_blank()) + 
  labs(x="Academic Year",y="Multi-Year APR Score")
```

$Y_i,_j,_k = \alpha_0 +\beta_1APR_i,_j,_k + \epsilon_i,_j,_k$

```{r}
OLSpartial = lm(Pct ~ centeredAPR, data = sports)

coef(summary(OLSpartial))
```

$Y_i,_j,_k = \alpha_0 +\beta_1APR_i,_j,_k + \beta_2Enrollment_i + \beta_3PercentCommunication_i + \beta_4NewEngland_i + \beta_5MidEast_i + \beta_6GreatLakes_i + \beta_7Plains_i + \beta_8SouthEast_i + \beta_9SouthWest_i + \beta_10RockyMountains_i + \beta_11FarWest_i + \beta_12Outlying_i + \epsilon_i,_j,_k$

```{r}
OLSfull = lm(Pct ~ centeredAPR + ugds + pcip09 + factor(region), data = sports)

coef(summary(OLSfull))
```

$Y_i,_j,_k = \alpha_0 +\beta_1APR_i,_j,_k + s_i + p_i,_j + \epsilon_i,_j,_k$

```{r}
partialintercept = lmer(Pct ~ centeredAPR + (1|School) + (1|program.id), REML=T, data=sports)

VCrandom <- VarCorr(partialintercept)
print(VCrandom, comp = c("Variance", "Std.Dev."))
cat(" Number of Level Two groups = ",
    summary(partialintercept)$ngrps[1], "\n", 
    "Number of Level Three groups = ",
    summary(partialintercept)$ngrps[2])
coef(summary(partialintercept))
```

$Y_i,_j,_k = \alpha_0 + \beta_1APR_i,_j,_k  + \beta_2Enrollment_i + \beta_3PercentCommunication_i + \beta_4NewEngland_i + \beta_5MidEast_i + \beta_6GreatLakes_i + \beta_7Plains_i + \beta_8SouthEast_i + \beta_9SouthWest_i + \beta_10RockyMountains_i + \beta_11FarWest_i + \beta_12Outlying_i + s_i + p_i,_j + \epsilon_i,_j,_k$

```{r}
fullintercept = lmer(Pct ~ centeredAPR + ugds + pcip09 + factor(region) + (1|School) + (1|program.id), REML=T, data=sports)

VCrandom <- VarCorr(fullintercept)
print(VCrandom, comp = c("Variance", "Std.Dev."))
cat(" Number of Level Two groups = ",
    summary(fullintercept)$ngrps[1], "\n", 
    "Number of Level Three groups = ",
    summary(fullintercept)$ngrps[2])
coef(summary(fullintercept))
```

$Y_i,_j,_k = \alpha_0 +\beta_1APR_i,_j,_k + s_i + m_iAPR + p_i,_j + \epsilon_i,_j,_k$

```{r}
partialschoolslope = lmer(Pct ~ centeredAPR + (centeredAPR|School) + (1|program.id), REML=T, data=sports)

VCrandom <- VarCorr(partialschoolslope)
print(VCrandom, comp = c("Variance", "Std.Dev."))
cat(" Number of Level Two groups = ",
    summary(partialschoolslope)$ngrps[1], "\n", 
    "Number of Level Three groups = ",
    summary(partialschoolslope)$ngrps[2])
coef(summary(partialschoolslope))
```

$Y_i,_j,_k = \alpha_0 +\beta_1APR_i,_j,_k + \beta_2Enrollment_i + \beta_3PercentCommunication_i + \beta_4NewEngland_i + \beta_5MidEast_i + \beta_6GreatLakes_i + \beta_7Plains_i + \beta_8SouthEast_i + \beta_9SouthWest_i + \beta_10RockyMountains_i + \beta_11FarWest_i + \beta_12Outlying_i + s_i + m_iAPR + p_i,_j + \epsilon_i,_j,_k$

```{r}
fullschoolslope = lmer(Pct ~ centeredAPR + ugds + pcip09 + factor(region) + (centeredAPR|School) + (1|program.id), REML=T, data=sports)

VCrandom <- VarCorr(fullschoolslope)
print(VCrandom, comp = c("Variance", "Std.Dev."))
cat(" Number of Level Two groups = ",
    summary(fullschoolslope)$ngrps[1], "\n", 
    "Number of Level Three groups = ",
    summary(fullschoolslope)$ngrps[2])
coef(summary(fullschoolslope))
```

$Y_i,_j,_k = \alpha_0 +\beta_1APR_i,_j,_k + s_i + p_i,_j + m_iAPR + \epsilon_i,_j,_k$

```{r}
partialprogramslope = lmer(Pct ~ centeredAPR + (1|School) + (centeredAPR|program.id), REML=T, data=sports)

VCrandom <- VarCorr(partialprogramslope)
print(VCrandom, comp = c("Variance", "Std.Dev."))
cat(" Number of Level Two groups = ",
    summary(partialprogramslope)$ngrps[1], "\n", 
    "Number of Level Three groups = ",
    summary(partialprogramslope)$ngrps[2])
coef(summary(partialprogramslope))
```

$Y_i,_j,_k = \alpha_0 +\beta_1APR_i,_j,_k + \beta_2Enrollment_i + \beta_3PercentCommunication_i + \beta_4NewEngland_i + \beta_5MidEast_i + \beta_6GreatLakes_i + \beta_7Plains_i + \beta_8SouthEast_i + \beta_9SouthWest_i + \beta_10RockyMountains_i + \beta_11FarWest_i + \beta_12Outlying_i + s_i + p_i,_j + m_iAPR + \epsilon_i,_j,_k$

```{r}
fullprogramslope = lmer(Pct ~ centeredAPR + ugds + pcip09 + factor(region) + (1|School) + (centeredAPR|program.id), REML=T, data=sports)

VCrandom <- VarCorr(fullprogramslope)
print(VCrandom, comp = c("Variance", "Std.Dev."))
cat(" Number of Level Two groups = ",
    summary(fullprogramslope)$ngrps[1], "\n", 
    "Number of Level Three groups = ",
    summary(fullprogramslope)$ngrps[2])
coef(summary(fullprogramslope))
```
